# Pyris V2

Pyris is an intermediary system that connects the [Artemis](https://github.com/ls1intum/Artemis) platform with various Large Language Models (LLMs). It provides a REST API that allows Artemis to interact with different pipelines based on specific tasks.

Currently, Pyris powers [Iris](https://artemis.cit.tum.de/about-iris), a virtual AI tutor that assists students with their programming exercises on Artemis in a pedagogically meaningful way.

## Table of Contents
- [Features](#features)
- [Setup](#setup)
  - [Prerequisites](#prerequisites)
  - [Local Environment Setup](#local-environment-setup)
  - [Docker Setup](#docker-setup)
    - [Development Environment](#development-environment)
    - [Production Environment](#production-environment)
- [Customizing Configuration](#customizing-configuration)
- [Troubleshooting](#troubleshooting)
- [Additional Notes](#additional-notes)

## Features

- **Exercise Support**: Empowers Iris to provide feedback on programming exercises, enhancing the learning experience for students. Iris analyzes submitted code, feedback, and build logs generated by Artemis to provide detailed insights.

- **Course Content Support**: Leverages RAG (Retrieval-Augmented Generation) to enable Iris to provide detailed explanations for course content, making it easier for students to understand complex topics based on instructor-provided learning materials.

- **Competency Generation**: Automates the generation of competencies for courses, reducing manual effort in creating Artemis competencies.

## Setup

### Prerequisites

- **Python 3.12**: Ensure that Python 3.12 is installed.
  ```bash
  python --version
  ```
- **Docker and Docker Compose**: Required for containerized deployment.

### Local Environment Setup

> **Note:** If you need to modify the local Weaviate vector database setup, please refer to the [Weaviate Documentation](https://weaviate.io/developers/weaviate/quickstart).

#### Steps

1. **Install Dependencies**

   Install the required Python packages:

   ```bash
   pip install -r requirements.txt
   ```

2. **Create Configuration Files**

   - **`application.local.yml`**

     Create an `application.local.yml` file in the root directory. This file includes configurations used by the application.

     ```yaml
     api_keys:
       - token: "your-secret-token"

     weaviate:
       host: "localhost"
       port: "8001"
       grpc_port: "50051"

     env_vars:
       test: "test-value"
     ```

   - **`llm-config.local.yml`**

     Create an `llm-config.local.yml` file in the root directory. This file includes a list of models with their configurations.

     ```yaml
     - id: "model-1"
       name: "Custom Model Name"
       description: "Description of your model"
       type: "azure-chat"  # e.g., azure-chat, ollama
       endpoint: "https://your-model-endpoint"
       api_version: "v1"
       azure_deployment: "your-azure-deployment-name"
       model: "gpt-3.5-turbo"
       api_key: "your-api-key"
       tools: []
       capabilities:
         input_cost: 0.5
         output_cost: 1.5
         gpt_version_equivalent: 3.5
         context_length: 16385
         vendor: "Your Vendor"
         privacy_compliance: True
         self_hosted: False
         image_recognition: False
         json_mode: True
     ```

     > **Note:** Each model configuration includes capabilities that help the application select the best model for a specific task.

3. **Run the Server**

   Start the Pyris server:

   ```bash
   APPLICATION_YML_PATH=./application.local.yml \
   LLM_CONFIG_PATH=./llm-config.local.yml \
   uvicorn app.main:app --reload
   ```

4. **Access API Documentation**

   Open your browser and navigate to [http://localhost:8000/docs](http://localhost:8000/docs) to access the interactive API documentation.

### Docker Setup

Deploying Pyris using Docker ensures a consistent environment and simplifies the deployment process.

#### Prerequisites

- **Docker**: Install Docker from the [official website](https://www.docker.com/get-started).
- **Docker Compose**: Comes bundled with Docker Desktop or install separately on Linux.

#### Docker Compose Files

- **Development**: `docker-compose/pyris-dev.yml`
- **Production with Nginx**: `docker-compose/pyris-production.yml`
- **Production without Nginx**: `docker-compose/pyris-production-internal.yml`

#### Running the Containers

##### **Development Environment**

1. **Start the Containers**

   ```bash
   docker-compose -f docker-compose/pyris-dev.yml up --build
   ```

   - Builds the Pyris application.
   - Starts Pyris and Weaviate in development mode.
   - Mounts local configuration files for easy modification.

2. **Access the Application**

   - Application URL: [http://localhost:8000](http://localhost:8000)
   - API Docs: [http://localhost:8000/docs](http://localhost:8000/docs)

##### **Production Environment**

###### **Option 1: With Nginx**

1. **Prepare SSL Certificates**

   - Place your SSL certificate (`fullchain.pem`) and private key (`priv_key.pem`) in the specified paths or update the paths in the Docker Compose file.

2. **Start the Containers**

   ```bash
   docker-compose -f docker-compose/pyris-production.yml up -d
   ```

   - Pulls the latest Pyris image.
   - Starts Pyris, Weaviate, and Nginx.
   - Nginx handles SSL termination and reverse proxying.

3. **Access the Application**

   - Application URL: `https://your-domain.com`

###### **Option 2: Without Nginx**

1. **Start the Containers**

   ```bash
   docker-compose -f docker-compose/pyris-production-internal.yml up -d
   ```

   - Pulls the latest Pyris image.
   - Starts Pyris and Weaviate.

2. **Access the Application**

   - Application URL: [http://localhost:8000](http://localhost:8000)

#### Managing the Containers

- **Stop the Containers**

  ```bash
  docker-compose -f <compose-file> down
  ```

  Replace `<compose-file>` with the appropriate Docker Compose file.

- **View Logs**

  ```bash
  docker-compose -f <compose-file> logs -f <service-name>
  ```

  Example:

  ```bash
  docker-compose -f docker-compose/pyris-dev.yml logs -f pyris-app
  ```

- **Rebuild Containers**

  If you've made changes to the code or configurations:

  ```bash
  docker-compose -f <compose-file> up --build
  ```

## Customizing Configuration

- **Environment Variables**

  You can customize settings using environment variables:

  - `PYRIS_DOCKER_TAG`: Specifies the Pyris Docker image tag.
  - `PYRIS_APPLICATION_YML_FILE`: Path to your `application.yml` file.
  - `PYRIS_LLM_CONFIG_YML_FILE`: Path to your `llm-config.yml` file.
  - `PYRIS_PORT`: Host port for Pyris application (default is `8000`).
  - `WEAVIATE_PORT`: Host port for Weaviate REST API (default is `8001`).
  - `WEAVIATE_GRPC_PORT`: Host port for Weaviate gRPC interface (default is `50051`).

- **Configuration Files**

  Modify configuration files as needed:

  - **Pyris Configuration**: Update `application.yml` and `llm-config.yml`.
  - **Weaviate Configuration**: Adjust settings in `weaviate.yml`.
  - **Nginx Configuration**: Modify Nginx settings in `nginx.yml` and related config files.

## Troubleshooting

- **Port Conflicts**

  If you encounter port conflicts, change the host ports using environment variables:

  ```bash
  export PYRIS_PORT=8080
  ```

- **Permission Issues**

  Ensure you have the necessary permissions for files and directories, especially for SSL certificates.

- **Docker Resources**

  If services fail to start, ensure Docker has sufficient resources allocated.

## Additional Notes

- **Accessing Services Internally**

  - Within Docker, services can communicate using service names (e.g., `pyris-app`, `weaviate`).

- **SSL Certificates**

  - Ensure SSL certificates are valid and properly secured.
  - Update paths in the Docker Compose file if necessary.

- **Scaling**

  - For increased load, consider scaling services or using orchestration tools like Kubernetes.